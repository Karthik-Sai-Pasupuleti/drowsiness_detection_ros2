<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Drowsiness Labeling Tool</title>
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;500;600;800&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- 1. CSS VARIABLES (Twilight Theme) --- */
        :root {
            --grad-start: #8b5cf6; /* Violet */
            --grad-end: #ec4899;   /* Pink */
            --success: #10b981;    /* Emerald */
            --warning: #f59e0b;    /* Amber */
            --danger: #f43f5e;     /* Rose */
            --info: #06b6d4;       /* Cyan (for Smooth BPM) */
            --trans-speed: 0.3s;
        }

        [data-theme="light"] {
            --bg-body: #f3f4f6;
            --bg-panel: #ffffff;
            --bg-input: #f9fafb;
            --border-color: #e5e7eb;
            --text-main: #111827;
            --text-muted: #6b7280;
            --shadow-panel: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --chart-bg: #ffffff;
            --chart-border: #e5e7eb;
            --btn-bg: #f3f4f6;
            --btn-text: #374151;
        }

        [data-theme="dark"] {
            --bg-body: #0f172a;
            --bg-panel: #1e293b;
            --bg-input: #020617;
            --border-color: #334155;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --shadow-panel: 0 10px 15px -3px rgba(0, 0, 0, 0.4);
            --chart-bg: #1e293b;
            --chart-border: #334155;
            --btn-bg: #334155;
            --btn-text: #cbd5e1;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color var(--trans-speed), color var(--trans-speed);
        }

        header {
            height: 70px;
            background-color: var(--bg-panel);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 0 20px;
            box-shadow: var(--shadow-panel);
            z-index: 20;
        }

        header h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 800;
            letter-spacing: -0.5px;
            text-transform: uppercase;
            background: linear-gradient(135deg, var(--grad-start), var(--grad-end));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-right {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
        }

        .theme-toggle-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-muted);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: 0.2s;
        }

        .theme-toggle-btn:hover {
            background: var(--bg-input);
            color: var(--text-main);
        }

        .container {
            display: flex;
            flex: 1;
            padding: 20px;
            gap: 20px;
            overflow: hidden;
        }

        .panel {
            background-color: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            box-shadow: var(--shadow-panel);
            display: flex;
            flex-direction: column;
        }

        #left_panel {
            width: 320px;
            min-width: 300px;
            padding: 20px;
            overflow-y: auto;
        }

        .groupbox {
            margin-bottom: 25px;
        }

        label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 700;
            color: var(--text-muted);
            margin-bottom: 8px;
            display: block;
        }

        input, textarea {
            width: 100%;
            background-color: var(--bg-input);
            border: 1px solid var(--border-color);
            color: var(--text-main);
            padding: 12px;
            border-radius: 8px;
            box-sizing: border-box;
            font-family: inherit;
        }

        input:focus, textarea:focus {
            outline: 2px solid var(--grad-start);
            border-color: transparent;
        }

        button {
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .drowsiness_btn, .action_btn, .voice_feedback_btn, #save_video_btn {
            padding: 10px;
            margin: 4px;
            border-radius: 8px;
            border: 1px solid transparent;
            background-color: var(--btn-bg);
            color: var(--btn-text);
            flex-grow: 1;
        }

        .drowsiness_btn:hover, .action_btn:hover {
            transform: translateY(-2px);
        }

        button[data-level="Low"].selected { background: var(--success); color: #fff; box-shadow: 0 4px 10px rgba(16, 185, 129, 0.4); }
        button[data-level="Moderate"].selected { background: var(--warning); color: #000; box-shadow: 0 4px 10px rgba(245, 158, 11, 0.4); }
        button[data-level="High"].selected { background: var(--danger); color: #fff; box-shadow: 0 4px 10px rgba(244, 63, 94, 0.4); }
        .action_btn.selected, .voice_feedback_btn.selected { background: linear-gradient(135deg, var(--grad-start), var(--grad-end)); color: white; box-shadow: 0 4px 10px rgba(139, 92, 246, 0.4); }

        #save_video_btn {
            width: 100%;
            margin-top: 10px;
            border: 1px solid var(--danger);
            background: transparent;
            color: var(--danger);
        }
        #save_video_btn.selected { background: var(--danger); color: white; }

        .info-card {
            background: var(--bg-input);
            padding: 15px;
            border-radius: 10px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            border: 1px solid var(--border-color);
        }
        .info-stat span:last-child {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.2rem;
            font-weight: 700;
        }
        .red-timer { color: var(--danger); }
        .green-timer { color: var(--success); }

        #camera_panel {
            flex: 2;
            background-color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }
        #camera_feed { width: 100%; height: 100%; object-fit: contain; }

        #right_panel {
            width: 35%;
            max-width: 450px;
            padding: 15px;
            gap: 15px;
            overflow-y: auto;
            background-color: var(--bg-body);
            border: none;
            box-shadow: none;
        }

        .draggable-chart {
            background-color: var(--chart-bg);
            border: 1px solid var(--chart-border);
            border-radius: 12px;
            padding: 10px;
            height: 200px;
            position: relative;
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
        }
        .draggable-chart:active { cursor: grabbing; }
        .draggable-chart.dragging { opacity: 0.5; border: 2px dashed var(--grad-start); transform: scale(0.98); }
        .drag-handle { position: absolute; top: 8px; right: 8px; color: var(--text-muted); cursor: grab; z-index: 10; font-size: 1.2rem; }
        .drag-handle:hover { color: var(--grad-start); }
        canvas { flex-grow: 1; width: 100% !important; height: 100% !important; }

        #notification-bar {
            position: fixed; top: 80px; left: 50%; transform: translateX(-50%);
            padding: 10px 24px; border-radius: 30px; font-weight: 600; z-index: 2000;
            display: none; backdrop-filter: blur(8px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        @media (max-width: 1200px) {
            .container { flex-direction: column; overflow-y: auto; }
            #left_panel, #right_panel, #camera_panel { width: 100%; max-width: none; }
            #camera_panel { min-height: 400px; }
        }
    </style>
</head>

<body>

    <header>
        <h1><i class="fas fa-car-on"></i> Driver Drowsiness Labeling Tool</h1>
        <div class="header-right">
            <button class="theme-toggle-btn" id="theme-toggle" onclick="toggleTheme()">
                <i class="fas fa-moon"></i> Theme
            </button>
        </div>
    </header>

    <div id="notification-bar"></div>

    <div class="container">

        <div class="panel" id="left_panel">
            <div class="groupbox">
                <label>Annotator Name</label>
                <input type="text" id="annotator_name" placeholder="Who is labeling?" />
            </div>

            <div class="groupbox">
                <label>Session Info</label>
                <div class="info-card">
                    <div class="info-stat">
                        <span>Window</span>
                        <span id="window-id">0</span>
                    </div>
                    <div class="info-stat">
                        <span>Timer</span>
                        <span id="main-timer" class="timer-display">--</span>
                    </div>
                    <div class="info-stat" style="grid-column: span 2;">
                        <span>Phase</span>
                        <span id="current-phase" style="font-size: 0.9rem;">Collecting</span>
                    </div>
                </div>
                <p id="status-message" style="margin-top:10px; font-size: 0.8rem; color: var(--text-muted); font-style: italic;"></p>
            </div>

            <div class="groupbox">
                <label>Drowsiness Level</label>
                <div style="display: flex; gap: 5px;">
                    <button class="drowsiness_btn" data-level="Low">Low</button>
                    <button class="drowsiness_btn" data-level="Moderate">Mod</button>
                    <button class="drowsiness_btn" data-level="High">High</button>
                </div>
            </div>

            <div class="groupbox">
                <label>Notes</label>
                <textarea id="notes" placeholder="Behavioral observations..."></textarea>
            </div>

            <div class="groupbox">
                <label>Countermeasures</label>
                <div style="display: flex; flex-wrap: wrap;">
                    <button class="action_btn" data-action="Fan"><i class="fas fa-fan"></i> Fan</button>
                    <button class="action_btn" data-action="Voice Command" id="voice_command_btn"><i class="fas fa-microphone"></i> Voice</button>
                    <button class="action_btn" data-action="Steering Vibration"><i class="fas fa-wave-square"></i> Vibrate</button>
                </div>
                <div id="voice_command_options" style="margin-top: 10px; display: flex; gap: 5px;">
                    <button class="voice_feedback_btn" data-feedback="Yes" style="flex:1">Response: Yes</button>
                    <button class="voice_feedback_btn" data-feedback="No" style="flex:1">Response: No</button>
                </div>
            </div>

            <div class="groupbox">
                <button id="save_video_btn"><i class="fas fa-video"></i> Save Video Segment</button>
            </div>
        </div>

        <div class="panel" id="camera_panel">
            <img id="camera_feed" src="/video_feed" alt="Waiting for stream..." />
        </div>

        <div id="right_panel">

            <div class="draggable-chart" draggable="true" id="chart-container-1">
                <i class="fas fa-grip-lines drag-handle"></i>
                <canvas id="earChart"></canvas>
            </div>

            <div class="draggable-chart" draggable="true" id="chart-container-2">
                <i class="fas fa-grip-lines drag-handle"></i>
                <canvas id="marChart"></canvas>
            </div>

            <div class="draggable-chart" draggable="true" id="chart-container-3">
                <i class="fas fa-grip-lines drag-handle"></i>
                <canvas id="steeringChart"></canvas>
            </div>

            <div class="draggable-chart" draggable="true" id="chart-container-4">
                <i class="fas fa-grip-lines drag-handle"></i>
                <canvas id="hrChart"></canvas>
            </div>

        </div>

    </div>

    <script>
        // --- GLOBAL VARS ---
        const notificationBar = document.getElementById('notification-bar');
        const statusMessage = document.getElementById('status-message');
        const mainTimerDisplay = document.getElementById('main-timer');
        
        let selectedDrowsiness = null;
        let selectedActions = new Set();
        let selectedVoiceFeedback = null;
        let currentWindowId = 0;
        let hasSubmittedForCurrentWindow = false;
        let hasRequestedVideoSave = false;
        const LABELING_THRESHOLD = 10;

        // --- THEME & UI LOGIC ---
        function toggleTheme() {
            const html = document.documentElement;
            const btnIcon = document.querySelector('#theme-toggle i');
            if (html.getAttribute('data-theme') === 'light') {
                html.setAttribute('data-theme', 'dark');
                btnIcon.className = 'fas fa-sun';
            } else {
                html.setAttribute('data-theme', 'light');
                btnIcon.className = 'fas fa-moon';
            }
            updateChartTheme();
        }

        function showNotification(msg, isError = false) {
            notificationBar.textContent = msg;
            notificationBar.style.display = 'block';
            notificationBar.style.backgroundColor = isError ? 'var(--danger)' : 'var(--warning)';
            notificationBar.style.color = isError ? 'white' : '#111';
            setTimeout(() => { notificationBar.style.display = 'none'; }, 5000);
        }

        // --- DATA FETCH LOOP ---
        function fetchDataAndRender() {
            fetch('/get_live_data').then(res => res.json()).then(data => {
                updateUI(data);
                updatePlots(data);
            }).catch(error => { console.error('Fetch error:', error); });
        }
        setInterval(fetchDataAndRender, 200);

        function updateUI(data) {
            const phase_info = data.phase_info || {};
            const windowId = phase_info.window_id || 0;
            const remainingTime = phase_info.remaining_time || 0;
            const isLabelingPhase = (remainingTime <= LABELING_THRESHOLD);

            document.getElementById('window-id').textContent = windowId;
            document.getElementById('current-phase').textContent = isLabelingPhase ? "Labeling" : "Collecting";
            mainTimerDisplay.textContent = remainingTime.toFixed(0);
            mainTimerDisplay.className = isLabelingPhase ? 'timer-display red-timer' : 'timer-display green-timer';

            if (windowId !== currentWindowId) {
                if (windowId > currentWindowId) handleWindowTransition(currentWindowId);
                currentWindowId = windowId;
                resetLabelingUI();
                statusMessage.textContent = `New window ${windowId} started.`;
            }

            if (remainingTime < 1 && !hasSubmittedForCurrentWindow) {
                handleWindowTransition(currentWindowId);
            }

            if (isLabelingPhase) {
                statusMessage.textContent = `⚠️ Label window ${windowId} now. Auto-submit: ${remainingTime.toFixed(0)}s.`;
            } else {
                statusMessage.textContent = `Collecting data...`;
            }
        }

        function handleWindowTransition(windowIdToSubmit) {
            if (!hasSubmittedForCurrentWindow) {
                submitLabels(windowIdToSubmit);
                hasSubmittedForCurrentWindow = true;
            }
        }

        function resetLabelingUI() {
            document.querySelectorAll('.drowsiness_btn').forEach(b => b.classList.remove('selected'));
            document.querySelectorAll('.action_btn').forEach(b => b.classList.remove('selected'));
            document.querySelectorAll('.voice_feedback_btn').forEach(b => b.classList.remove('selected'));
            document.getElementById('save_video_btn').classList.remove('selected');

            selectedDrowsiness = null;
            selectedActions.clear();
            selectedVoiceFeedback = null;
            document.getElementById('notes').value = "";
            hasSubmittedForCurrentWindow = false;
            hasRequestedVideoSave = false;
        }

        // --- DRAG AND DROP ---
        const draggables = document.querySelectorAll('.draggable-chart');
        const rightPanel = document.getElementById('right_panel');
        draggables.forEach(draggable => {
            draggable.addEventListener('dragstart', () => draggable.classList.add('dragging'));
            draggable.addEventListener('dragend', () => {
                draggable.classList.remove('dragging');
                earChart.resize(); marChart.resize(); steeringChart.resize(); hrChart.resize();
            });
        });
        rightPanel.addEventListener('dragover', e => {
            e.preventDefault();
            const afterElement = getDragAfterElement(rightPanel, e.clientY);
            const draggable = document.querySelector('.dragging');
            if (afterElement == null) rightPanel.appendChild(draggable);
            else rightPanel.insertBefore(draggable, afterElement);
        });
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.draggable-chart:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) return { offset: offset, element: child };
                else return closest;
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // --- CHARTS CONFIG ---
        function getThemeChartColor() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            return {
                grid: isDark ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)',
                text: isDark ? '#94a3b8' : '#64748b'
            };
        }

        const createChart = (ctx, label, color, y_title) => {
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: label,
                        borderColor: color,
                        data: [],
                        fill: false,
                        tension: 0.3,
                        pointRadius: 0,
                        borderWidth: 2
                    }]
                },
                options: {
                    animation: false,
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { display: true, grid: { display: false } },
                        y: { title: { display: true, text: y_title }, grid: { color: 'rgba(0,0,0,0.1)' } }
                    },
                    plugins: { legend: { display: true } }
                }
            });
        };

        const earChart = createChart(document.getElementById('earChart').getContext('2d'), 'EAR (Eye)', '#8b5cf6', 'EAR');
        const marChart = createChart(document.getElementById('marChart').getContext('2d'), 'MAR (Mouth)', '#ec4899', 'MAR');
        const steeringChart = createChart(document.getElementById('steeringChart').getContext('2d'), 'Steering', '#f43f5e', 'Angle');
        
        // NEW: Multi-line Heart Rate Chart
        const hrChart = new Chart(document.getElementById('hrChart').getContext('2d'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Instant BPM',
                        borderColor: '#ef4444', // Red (Raw)
                        data: [],
                        fill: false,
                        tension: 0.2,
                        pointRadius: 0,
                        borderWidth: 1
                    },
                    {
                        label: 'Smooth BPM',
                        borderColor: '#06b6d4', // Cyan (Smooth)
                        data: [],
                        fill: false,
                        tension: 0.4,
                        pointRadius: 0,
                        borderWidth: 2
                    }
                ]
            },
            options: {
                animation: false,
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { display: true, grid: { display: false } },
                    y: { title: { display: true, text: 'BPM' }, grid: { color: 'rgba(0,0,0,0.1)' } }
                },
                plugins: { legend: { display: true } }
            }
        });

        function updatePlots(data) {
            const themeColors = getThemeChartColor();

            function updateSingleLineChart(chart, array, y_title, offset = 0.05) {
                if (!array || array.length === 0) return;
                const n = array.length;
                const labels = Array.from({ length: n }, (_, i) => -((n - 1 - i) * (1 / 60)).toFixed(2));
                
                chart.data.labels = labels;
                chart.data.datasets[0].data = array;
                
                // Scale config
                const minVal = Math.min(...array);
                const maxVal = Math.max(...array);
                chart.options.scales.x.min = -6;
                chart.options.scales.x.max = 0;
                chart.options.scales.y.min = minVal - offset;
                chart.options.scales.y.max = maxVal + offset;
                
                // Theme colors
                chart.options.scales.x.grid.color = themeColors.grid;
                chart.options.scales.y.grid.color = themeColors.grid;
                chart.options.scales.x.ticks.color = themeColors.text;
                chart.options.scales.y.ticks.color = themeColors.text;
                chart.options.plugins.legend.labels.color = themeColors.text;
                chart.update();
            }

            // Standard Single Line Charts
            updateSingleLineChart(earChart, data.live_ear, 'EAR', 0.02);
            updateSingleLineChart(marChart, data.live_mar, 'MAR', 0.02);
            updateSingleLineChart(steeringChart, data.live_steering, 'Angle', 0.1);

            // Special Update for Multi-Line Heart Rate Chart
            if (data.live_hr_instant && data.live_hr_smooth) {
                const n = data.live_hr_instant.length;
                const labels = Array.from({ length: n }, (_, i) => -((n - 1 - i) * (1 / 60)).toFixed(2));
                
                hrChart.data.labels = labels;
                hrChart.data.datasets[0].data = data.live_hr_instant;
                hrChart.data.datasets[1].data = data.live_hr_smooth;

                // Combine arrays to find min/max for scaling
                const allHr = [...data.live_hr_instant, ...data.live_hr_smooth];
                const minVal = Math.min(...allHr);
                const maxVal = Math.max(...allHr);

                hrChart.options.scales.x.min = -6;
                hrChart.options.scales.x.max = 0;
                hrChart.options.scales.y.min = Math.max(0, minVal - 5);
                hrChart.options.scales.y.max = maxVal + 5;

                // Apply Theme
                hrChart.options.scales.x.grid.color = themeColors.grid;
                hrChart.options.scales.y.grid.color = themeColors.grid;
                hrChart.options.scales.x.ticks.color = themeColors.text;
                hrChart.options.scales.y.ticks.color = themeColors.text;
                hrChart.options.plugins.legend.labels.color = themeColors.text;

                hrChart.update();
            }
        }

        function updateChartTheme() {
            earChart.update(); marChart.update(); steeringChart.update(); hrChart.update();
        }

        // --- BUTTON HANDLERS ---
        document.querySelectorAll('.drowsiness_btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (btn.disabled) return;
                document.querySelectorAll('.drowsiness_btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedDrowsiness = btn.dataset.level;
                storeSelectedLabels();
            });
        });

        document.querySelectorAll('.action_btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (btn.disabled) return;
                const action = btn.dataset.action;
                const isSelected = btn.classList.toggle('selected');
                if (isSelected) {
                    selectedActions.add(action);
                    activateAction(action);
                } else {
                    selectedActions.delete(action);
                }
                storeSelectedLabels();
            });
        });
        
        document.querySelectorAll('.voice_feedback_btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.voice_feedback_btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedVoiceFeedback = btn.dataset.feedback;
                activateAction('Voice Feedback', selectedVoiceFeedback);
                storeSelectedLabels();
            });
        });

        const saveVideoBtn = document.getElementById('save_video_btn');
        saveVideoBtn.addEventListener('click', () => {
            const isSelected = saveVideoBtn.classList.toggle('selected');
            hasRequestedVideoSave = isSelected;
            storeSelectedLabels();
            showNotification(isSelected ? "Video save requested." : "Video save canceled.");
        });

        // --- SUBMISSION ---
        async function submitLabels(windowIdToSubmit) {
            const annotator_name = document.getElementById('annotator_name').value.trim();
            if (!annotator_name) {
                showNotification(`Error: Please enter annotator name.`, true);
                return;
            }
            showNotification(`Submitting Window ${windowIdToSubmit}...`, false);
            await storeSelectedLabels();
        }

        async function storeSelectedLabels() {
            const annotator_name = document.getElementById('annotator_name').value.trim();
            if (!annotator_name) return;
            try {
                await fetch('/store_selected_labels', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        window_id: parseInt(document.getElementById('window-id').textContent),
                        annotator_name: annotator_name,
                        drowsiness_level: selectedDrowsiness,
                        actions: Array.from(selectedActions),
                        notes: document.getElementById('notes').value,
                        voice_feedback: selectedVoiceFeedback,
                        video_save_requested: hasRequestedVideoSave
                    })
                });
            } catch (error) { console.error('Store error:', error); }
        }

        async function activateAction(action, feedback = null) {
            try {
                await fetch('/activate_action', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: action, feedback: feedback })
                });
            } catch (error) { console.error('Action error:', error); }
        }
    </script>
</body>
</html>